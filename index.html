<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>DKæ•°å­—åˆ†èº«</title>
		<script src="js/vue.js" type="text/javascript" charset="utf-8"></script>
		<link rel="stylesheet" type="text/css" href="./css/litewebchat.css" />
		<!-- å¼•å…¥æ ·å¼ -->
		<link rel="stylesheet" href="./dist/theme-chalk/index.css">
		<link rel="stylesheet" type="text/css" href="./css/main.css" />
		<!-- å¼•å…¥ç»„ä»¶åº“ -->
		<script src="./dist/index.js"></script>
		<script src="https://cdn.2zimu.com/axios.min.js"></script>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
		<style>
			.el-input--small input:focus {
				transform: none;
				}
				.el-input input:focus {
				transform: none;
				}

				.el-input--large input:focus {
				transform: none;
				}
		</style>
	</head>
	<body>
		<body>
			<el-container id="app" class="paper">
				<el-header>
				<el-row>
						<el-col :span="12"><div class="app-title">DKæ•°å­—ç‰ˆ 0.1<i class="el-icon-info"></i></div></el-col>
						<el-col :span="12">
							<div style="text-align: right;">
								<a class="umami--click--give-feedback" href="https://wenjuan.feishu.cn/m?t=sD7JT3OVRyLi-tsre" v-if="showMoreInfo">
									<el-button size="small" round>ç»™æˆ‘ä¸€äº›åé¦ˆ ğŸ˜</el-button>
								</a>
								<a class="umami--click--learn-more" href="https://greatdk.com/1908.html" target="_blank"><el-button size="small" round>è®­ç»ƒæ•™ç¨‹</el-button></a></div></div></el-col>
				</el-row>
				<!-- <div class="app-title">DKæ•°å­—ç‰ˆ</div>
				<i class="el-icon-info"></i> -->
				</el-header>
				<el-alert
				title="ä¸è¦æŠ±æœ‰å¤ªé«˜æœŸæœ›"
				type="warning"
				description="æ¨¡å‹è®­ç»ƒæ‰€ç”¨æ•°æ®å‡ç”±æˆ‘æœ¬äººäº§ç”Ÿï¼Œä¸”ä»…ç”¨äºæµ‹è¯•ç›®çš„ï¼Œå®ƒä¸èƒ½å®Œæˆå¾ˆéš¾çš„ä»»åŠ¡ï¼Œåªèƒ½è·Ÿä½ é—²èŠï¼Œå¦‚æœå®ƒéª‚äº†äººï¼Œæˆ‘ä»£å®ƒå‘ä½ é“æ­‰ğŸ™‡"
				show-icon>
			  </el-alert>
				<el-main v-if="!is_sleep">
					<!-- ä¸»å®¹å™¨ -->
					<el-row :span="24">
						<div class="lite-chatbox">

							<div class="cmsg cleft" >
								<img class="headIcon radius" ondragstart="return false;" oncontextmenu="return false;" src="https://cdn.2zimu.com/mbd_file_NDdfNDE1ODM5XzE2ODA0NTAzNTQ1NTRfMTY4MDQ1MDM1NDU1NA.png-webicon" />
								<span class="name">DK</span>
								<span class="content">ä½ å¥½å“‡
								</span>
								<br><br>
								<el-row :gutter="20">
									<el-col class="umami--click--info-button" :span="6"><el-button @click="sendInfo" size="mini" round >ğŸ“– æŸ¥çœ‹è¯´æ˜</el-button></el-col>
									<el-col class="umami--click--priv-button" :span="6"><el-button @click="privInfo" size="mini" round >ğŸ”’ éšç§é—®é¢˜</el-button></el-col>
									<el-col class="umami--click--github-button" :span="6"><el-button @click="goGithub" size="mini" round >ğŸ’» github</el-button></el-col>
									<el-col class="umami--click--spon-button" :span="6"><el-button @click="goSixpen" size="mini" round >â¤ï¸ èµåŠ©äºº</el-button></el-col>
								</el-row>
							</div>
							<br>

							<div v-for="(message,index) in messageList" v-if="message.show" :key="index" class="cmsg" v-bind:class="message.direction">
								<img class="headIcon radius" ondragstart="return false;" oncontextmenu="return false;" v-bind:src=message.avatar />
								<span class="name">{{ message.nick }}</span>
								<span class="content">{{ message.msg }} 
									<el-button @click="getBest(message.msg_id,message.msg)" v-if="!message.first_message && message.direction=='cleft' && !message.has_vote " size="small" round >ğŸ‘</el-button>
									<!-- <el-button v-if="message.has_vote && message.direction=='cleft' " disabled size="small" round >å·²é€‰æ‹©</el-button> -->
								</span>
							</div>
						</div>
					</el-row>

					<div class="inputBox" v-loading="in_gen">
						<el-row>
							<el-col :span="15">
								<el-input v-model="inputBox"  @keyup.enter.native="send" placeholder="è¯·è¾“å…¥å†…å®¹"></el-input>
							</el-col>
							 
							<el-col :span="8">
								<el-button class="umami--click--send-button" @click="send" >å‘é€</el-button>
								<el-button class="umami--click--open-setting" @click="openSetting = ! openSetting" type="warning" icon="el-icon-s-tools" size="small" circle></el-button>
							<el-col>
						</el-row>

						<div v-if="openSetting" style="padding-top: 10px;background: white;">
							<el-row :gutter="20">
								<el-col :span="13">
								<el-input v-model="temperature" placeholder="å¦‚æœä½ ä¸çŸ¥é“è¿™æ˜¯å•¥ï¼Œå°±ä¸è¦æ”¹">
									<template slot="prepend">temperature</template>
								</el-input>
								</el-col>
								<el-col :span="9">
									<el-input v-model="top_p" placeholder="å¦‚æœä½ ä¸çŸ¥é“è¿™æ˜¯å•¥ï¼Œå°±ä¸è¦æ”¹">
										<template slot="prepend">top_p</template>
									</el-input>
								</el-col>
							</el-row>
							<br>
							<el-row :gutter="20">
								<el-col :span="12">
									<el-input v-model="num_beams" placeholder="å¦‚æœä½ ä¸çŸ¥é“è¿™æ˜¯å•¥ï¼Œå°±ä¸è¦æ”¹">
										<template slot="prepend">num_beams</template>
									</el-input>
								</el-col>
								<el-col :span="12">
									do_sample:
									<el-switch
										v-model="do_sample"
										active-color="#13ce66"
										inactive-color="#ff4949">
										</el-switch>
								</el-col>
							</el-row>
						</div>


					</div>
				</el-main>

				<el-main v-if="is_sleep">
					<el-result icon="warning" title="æ¥çš„ä¸å·§" sub-title="æ¨¡å‹åœ¨è°ƒæ•´ï¼Œæˆ–è€…æˆ‘æš‚æ—¶æŠŠæœåŠ¡å™¨å…³äº†">
						<template slot="extra">
						  <a href="https://6pen.art"><el-button class="umami--click--see-6pen" type="primary" size="medium">ğŸ‘€çœ‹çœ‹æˆ‘æçš„åˆ«çš„ä¸œè¥¿</el-button></a>
						</template>
					  </el-result>
				</el-main>
				<el-dialog
					title="é‚£ä¸ªï¼Œä½ èƒ½å¸®å¸®å¿™å—ï¼Ÿ"
					:visible.sync="dialogVisible"
					width="80%"
					>
					<span>åˆšåˆšç”Ÿæˆçš„2æ®µå›å¤ï¼Œè¯·ç‚¹å‡»ğŸ‘é€‰æ‹©ä½ è®¤ä¸ºæ›´å¥½çš„é‚£ä¸ªï¼Œæˆ‘ä¼šå°†è¿™ä¸ªæ•°æ®ç”¨æ¥ä¼˜åŒ–æ¨¡å‹ï¼ˆå®ƒæ˜¯åŒ¿åæœé›†çš„ï¼‰</span>
					<br>
					<span>å¦‚æœä»–ä»¬ç¡®å®éƒ½ä¸å¤ªè¡Œï¼Œè¯·ç‚¹å‡»ä¸‹é¢çš„é‡æ–°ç”ŸæˆæŒ‰é’®ï¼Œå°†ä¼šå†é‡æ–°ç”Ÿæˆä¸€æ¬¡</span>
					<span slot="footer" class="dialog-footer">						
						<el-button type="primary" @click="dialogVisible = false">å¥½çš„</el-button>
						<el-button @click="reGen">é‡æ–°ç”Ÿæˆ</el-button>
					</span>
					</el-dialog>
			</el-container>
		</body>
		
		<script type="text/javascript">
			var app = new Vue({
				el: '#app',
				data() {
					return {
						messageList: [],
						msg_id:"",
						dialogVisible:false,
						inputBox: '',
						openSetting: false,
						botNick: 'DK',
						history: [],
						showMoreInfo:false,
						thesaurus: '',
						botAvatar: 'https://cdn.2zimu.com/mbd_file_NDdfNDE1ODM5XzE2ODA0NTAzNTQ1NTRfMTY4MDQ1MDM1NDU1NA.png-webicon',
						myAvatar: 'https://cdn.2zimu.com/mbd_1630305272952_screenshot_1630305272750.jpg-webicon',
						do_sample: true,
						temperature:0.7,
						top_p:1,
						num_beams:1,
						in_gen:false,
						is_sleep:false
					}
			
				},
				methods: {
					// getThesaurus: function() {
					// 	axios.get('https://raw.githubusercontent.com/Kyomotoi/AnimeThesaurus/main/data.json')
					// 		.then((response) => this.thesaurus = response.data)
					// },
					getBest(id,text){
						var input = ""
						var good_answer = ""
						var bad_answer = ""
						console.log(this.messageList)
						this.messageList.forEach((element,index) => {
						if (element.msg_id === id) {
							element.has_vote = true;
							if (element.direction=='cright'){
								input = element.msg
							}
							if (element.msg==text && element.direction=='cleft'){
								this.history[this.history.length - 1][1] = element.msg
								good_answer = element.msg
							}
							if (element.msg!=text && element.direction=='cleft'){
								element.show = false
								bad_answer = element.msg
							}
						}
						});
						// å‘è®°å½•è¯·æ±‚
						axios.post('https://service-r2vz2ear-1251731618.bj.apigw.tencentcs.com/release/dk_ai_data_collect', { input: input, good_answer: good_answer, bad_answer:bad_answer}, {
							headers: { 'Content-Type': 'application/json' }
							})
							.then(function (response) {
								console.log(response.data)
							})
							.catch(function (error) {
							});
						//
					},
					sendInfo(){
						this.messageList.push({
						nick: "DK(çœŸäºº)",
						msg: 'ä½ å¥½ï¼Œæˆ‘æ˜¯ç”±ç‹ç™»ç§‘çš„å¾®ä¿¡èŠå¤©è®°å½•ï¼Œå¾®åšåŠæ–‡ç« ä½œä¸ºè®­ç»ƒæ•°æ®ï¼ŒåŸºäº chatglm-6b è®­ç»ƒçš„ä¸€ä¸ªæ¨¡å‹ï¼Œç›¸è¾ƒäº chatgpt è¿™æ ·çš„æ¨¡å‹ï¼Œæˆ‘çš„ç‰¹ç‚¹æ›´åƒæ˜¯æŸç§å¯¹ã€Œäººã€çš„å…‹éš†ï¼Œå› ä¸ºæˆ‘çš„æ‰€æœ‰æ¥æºéƒ½æ˜¯å°ç‹è¿™ä¸ªäººæ‰€ç”Ÿæˆçš„å†…å®¹ï¼ˆä»–çš„å›å¤ï¼Œä»–çš„æ–‡ç« ï¼Œä»–çš„æƒ³æ³•ï¼‰ã€‚æˆ‘å¹¶ä¸æ˜¯ä»–çš„ç™¾ç§‘ï¼Œæˆ‘ä¹Ÿä¸äº†è§£ä»–çš„æ‰€æœ‰äº‹æƒ…ï¼Œä½†æ˜¯æˆ‘å…·å¤‡æŸäº›å’Œä»–ä¸€æ ·çš„ç‰¹ç‚¹ï¼Œå› ä¸ºåœ¨è®­ç»ƒä¸­ï¼Œä»–çš„å†…å®¹é‡å¡‘äº†æˆ‘çš„60äº¿å‚æ•°',
						direction: 'cleft',
						avatar: this.botAvatar,
						first_message:true,
						show:true
					});
					},
					privInfo(){
						this.messageList.push({
						nick: "DK(çœŸäºº)",
						msg: 'ä¸è¦æ‹…å¿ƒï¼Œä½ åœ¨è¿™é‡Œçœ‹åˆ°çš„æ‰€æœ‰ä¿¡æ¯ï¼ŒåŸºæœ¬éƒ½æ˜¯æ¨¡å‹çç¼–çš„ï¼Œé¦–å…ˆï¼Œæˆ‘çš„æ•°æ®æœ‰è¿›è¡Œè¿‡æ»¤ï¼Œå…¶æ¬¡ï¼Œæˆ‘è®­ç»ƒçš„æ¨¡å‹çš„KVå±‚ï¼Œè¿™ä¸€å±‚å‚æ•°æ›´åƒæ˜¯ã€Œé€»è¾‘ã€éƒ¨åˆ†ï¼Œè€Œéã€ŒçŸ¥è¯†ã€éƒ¨åˆ†ï¼Œæ‰€ä»¥ä¸ä¼šæ­£ç¡®å›ç­”å…³äºæˆ‘çš„ä»»ä½•éšç§ï¼ŒæŸç§ç¨‹åº¦ä¸Šè¿™ä¹Ÿæ˜¯ä¹‹åè®­ç»ƒéœ€è¦ä¼˜åŒ–çš„åœ°æ–¹ï¼Œå³è®©æ¨¡å‹åœ¨å¯æ§èŒƒå›´å†…ã€Œè®°ä½ã€çŸ¥è¯†',
						direction: 'cleft',
						avatar: this.botAvatar,
						first_message:true,
						show:true
					});
					},
					goSixpen(){
						window.open("https://6pen.art?from=dkai", "_blank"); 
					},
					goGithub(){
						window.open("https://github.com/wdkwdkwdk/CLONE_DK", "_blank"); 
					},
					reGen(){
						this.messageList.forEach((element,index) => {
							if (element.msg_id === this.msg_id && element.direction == "cright" ) {
								this.inputBox = element.msg
							}
						})
						const resultArr = this.messageList.filter(item => {
						if (item.msg_id === this.msg_id) {
							return false; 
						}
						return true; 
						});
						this.messageList = resultArr
						this.dialogVisible = false
						console.log(this.dialogVisible)
						this.send()
					},
					getStatus(){
						this2 = this
						const requestData = {
							check_status: "yes"
						};
						axios.post("https://service-ei2k47mp-1251731618.bj.apigw.tencentcs.com/release/dk_ai", requestData, {
						headers: {
								"Content-Type": "application/json"
							}
						})
						.then(response => {
							console.log(response.data);
							if (response.data.state=="sleeping") {
								this2.is_sleep = true
							}
						})
						.catch(error => {
							console.error(error);
							if (response.data.state=="sleeping") {
								this2.is_sleep = true
							}
						});
					},
					open() {
						this.$alert('è¿™æ˜¯ä¸€æ®µå†…å®¹', 'æ ‡é¢˜åç§°', {
						confirmButtonText: 'ç¡®å®š',
						callback: action => {
							this.$message({
							type: 'info',
							message: `action: ${ action }`
							});
						}
						});
					},
					send: function() {
						let last_msg = this.messageList[this.messageList.length - 1]
						if(last_msg){
								if( last_msg.has_vote != true && !last_msg.first_message){
								this.dialogVisible = true
								return
							}
						}

						this.msg_id = Math.random().toString(36).substr(2) + Date.now().toString(36);
						if ( this.messageList.length > 3){
							this.showMoreInfo = true
						}
						this.in_gen = true
						this.messageList.push({
							nick: 'ä½ ',
							msg: this.inputBox,
							direction: 'cright',
							avatar: this.myAvatar,
							msg_id:this.msg_id,
							show:true
						});
						// var words = [],
						// 	reply = '';
						// for (obj in this.thesaurus) {
						// 	if (this.inputBox.indexOf(obj) != -1) {
						// 		words.push(obj);
						// 	}
						// }

						this2 = this
						axios.post('https://service-ei2k47mp-1251731618.bj.apigw.tencentcs.com/release/dk_ai', { text: this.inputBox, history: this.history, temperature:this.temperature, top_p:this.top_p, num_beams:this.num_beams,do_sample:this.do_sample }, {
							headers: { 'Content-Type': 'application/json' }
							})
							.then(function (response) {
								dk_response = response.data
								console.log(response.data);
								reply = dk_response.response
								back_reply = dk_response && dk_response.back && dk_response.back.response;
								this2.history = dk_response.history
								this2.in_gen = false
								if ( reply == null && this2.history == null) {
									alert("æˆ‘çš„ç¥–ä¼ V100æœåŠ¡å™¨ä¼¼ä¹å‡ºäº†ç‚¹ä»€ä¹ˆé—®é¢˜ï¼Œè¯·è¿‡æ®µæ—¶é—´å†çœ‹çœ‹")
								}
								else{
									this2.messageList.push({
									nick: this2.botNick,
									msg: reply,
									direction: 'cleft',
									avatar: this2.botAvatar,
									is_back_reply:false,
									msg_id:this2.msg_id,
									has_vote:false,
									show:true
								});
									if (back_reply){
										this2.messageList.push({
										nick: this2.botNick+"(åˆ†èº«1)",
										msg: back_reply,
										direction: 'cleft',
										avatar: this2.botAvatar,
										is_back_reply:true,
										msg_id:this2.msg_id,
										has_vote:false,
										show:true
									});}
								setTimeout(() => {
									var div = document.getElementsByClassName('el-main')[0];
									div.scrollTop = div.scrollHeight;
									this2.inputBox = '';
									this2.in_gen = false
								}, 100)
								}
							})
							.catch(function (error) {
								if (error == 'AxiosError: Request failed with status code 429' || error == 'Error: Request failed with status code 429') {
									alert("ä¸å¥½æ„æ€ï¼Œè¿™ä¸ªæœåŠ¡è·‘åœ¨ä¸€å°æœåŠ¡å™¨ä¸Šï¼Œå°±åƒä¸€ä¸ªäººä¸€æ ·ï¼Œå¤„ç†ä¸äº†å¤ªå¤šæ¶ˆæ¯ï¼Œæ‰€ä»¥æœ‰ä¸€äº›è®¿é—®æ§åˆ¶ï¼Œä½ å¯ä»¥è¿‡30ç§’å†å‘ä¸€æ¡è¯•è¯•çœ‹")
								}else{
									alert(error)
								}
								console.error(error);
								this2.in_gen = false
							});
					}
				},
				created: function() {
					this.getStatus();
					// this.messageList.push({
					// 	nick: this.botNick,
					// 	msg: 'åƒäº†å—æ‚¨',
					// 	direction: 'cleft',
					// 	avatar: this.botAvatar,
					// 	first_message:true,
					// 	show:true
					// });
				}
			});
		</script>
		<script async defer data-website-id="d8713d1f-bc47-4355-b53f-fd8e3da2daa2" src="https://analytics.greatdk.com/umami.js"></script>
</html>
